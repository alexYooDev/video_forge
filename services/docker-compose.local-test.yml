services:
  # Redis for API Gateway caching
  redis:
    image: redis:7-alpine
    container_name: redis-local
    ports:
      - "6379:6379"
    networks:
      - videoforge-local

  # Gallery Service
  gallery-service:
    build:
      context: ./gallery-service
      dockerfile: Dockerfile
    container_name: gallery-service-local
    env_file:
      - .env.local
    ports:
      - "5000:5000"
    environment:
      - PORT=5000
      - NODE_ENV=development
      - DB_PORT=5432
      # Pass AWS credentials from host (for local testing)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
    networks:
      - videoforge-local
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Streaming Service
  streaming-service:
    build:
      context: ./streaming-service
      dockerfile: Dockerfile
    container_name: streaming-service-local
    env_file:
      - .env.local
    ports:
      - "5001:5001"
    environment:
      - PORT=5001
      - NODE_ENV=development
      - AWS_REGION=ap-southeast-2
      # Database config
      - DB_HOST=${DB_HOST}
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-video_forge}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD}
      # S3 config
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-video-forge-storage}
      # Pass AWS credentials from host (for local testing)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
    networks:
      - videoforge-local
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway-local
    env_file:
      - .env.local
    ports:
      - "8000:8000"
    environment:
      - SERVER_PORT=8000
      - NODE_ENV=development
      - AWS_REGION=ap-southeast-2
      # Database config
      - PG_HOST=${DB_HOST}
      - PG_PORT=5432
      - PG_DATABASE=${DB_NAME:-video_forge}
      - PG_USERNAME=${DB_USER:-postgres}
      - PG_PASSWORD=${DB_PASSWORD}
      # Redis config (uses local redis container)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CACHE_ENABLED=true
      # S3 config
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-video-forge-storage}
      # Auth config
      - JWT_SECRET=${JWT_SECRET:-v8CH5wbdp9iPJHyBXQA2a8ALW58QJ9Ek}
      # Service URLs (point to local containers)
      - GALLERY_SERVICE_URL=http://gallery-service:5000
      - STREAMING_SERVICE_URL=http://streaming-service:5001
      # Pass AWS credentials from host (for local testing)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
    networks:
      - videoforge-local
    depends_on:
      gallery-service:
        condition: service_healthy
      streaming-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  videoforge-local:
    driver: bridge
